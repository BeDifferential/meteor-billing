{"version":3,"file":"/packages/billing.js","sources":["billing/collections/users.coffee","billing/client/views/creditCard/creditCard.html","billing/client/views/billing/billing.html","billing/client/views/billing/billing.coffee","billing/client/billing.coffee","billing/client/validation.coffee"],"names":[],"mappings":"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","sourcesContent":["class BillingUser extends Minimongoid\n  @_collection: Meteor.users","Template.__define__(\"creditCard\",Package.handlebars.Handlebars.json_ast_to_func([\"<div class=\\\"credit-card\\\">\\n    <h2>Billing Info <img src=\\\"/packages/billing/public/img/credit-cards.png\\\"></h2>\\n    <div class=\\\"form-section\\\">\\n      <div class=\\\"form-group\\\">\\n        <label>Card Number</label>\\n        <input type=\\\"number\\\" name=\\\"cc-num\\\" class=\\\"form-control\\\" placeholder=\\\"••••••••••••••••\\\"/>\\n      </div>\\n      <div class=\\\"row\\\">\\n        <div class=\\\"col-md-7\\\">\\n          <div class=\\\"expiration\\\">\\n            <label>Expiration</label>\\n            <div class=\\\"row\\\">\\n              <div class=\\\"col-xs-6\\\">\\n                <div class=\\\"form-group\\\">\\n                  <input type=\\\"number\\\" name=\\\"cc-exp-month\\\" class=\\\"form-control\\\" placeholder=\\\"MM\\\"/>\\n                </div>\\n              </div>\\n              <span> / </span>\\n              <div class=\\\"col-xs-6\\\">\\n                <div class=\\\"form-group\\\">\\n                  <input type=\\\"number\\\" name=\\\"cc-exp-year\\\" class=\\\"form-control\\\" placeholder=\\\"YYYY\\\"/>\\n                </div>\\n              </div>\\n            </div>\\n          </div>\\n        </div>\\n        <div class=\\\"col-md-5\\\">\\n          <div class=\\\"form-group\\\">\\n            <label>Card Code <img src=\\\"/packages/billing/public/img/cvc.png\\\"></label>\\n            <input type=\\\"number\\\" name=\\\"cc-cvc\\\" class=\\\"form-control\\\" placeholder=\\\"CVC\\\"/>\\n          </div>\\n        </div>\\n      </div>\\n    </div>\\n  </div>\"]));\n","Template.__define__(\"billing\",Package.handlebars.Handlebars.json_ast_to_func([\"<div class=\\\"container billing\\\">\\n    \",[\"#\",[[0,\"if\"],[0,\"billingError\"]],[\"\\n      <div class=\\\"row alert alert-danger\\\">\\n        <div class=\\\"col-xs-12\\\">\\n          \",[\"{\",[[0,\"billingError\"]]],\"\\n        </div>\\n      </div>\\n    \"]],\"\\n    \",[\"#\",[[0,\"if\"],[0,\"billingSuccess\"]],[\"\\n      <div class=\\\"row alert alert-success\\\">\\n        <div class=\\\"col-xs-12\\\">\\n          \",[\"{\",[[0,\"billingSuccess\"]]],\"\\n        </div>\\n      </div>\\n    \"]],\"\\n    <div class=\\\"row\\\">\\n      \\n      <div class=\\\"col-xs-6\\\">\\n        <h2>Past Invoices</h2>\\n        <div class=\\\"panel-group\\\" id=\\\"past-invoice-accordion\\\">\\n          \",[\"#\",[[0,\"each\"],[0,\"invoices\"]],[\"\\n            \",[\">\",\"_invoice\"],\"\\n          \"],[\"\\n            <i class=\\\"fa fa-spinner fa-3x fa-spin billing-loader\\\"></i>\\n          \"]],\"\\n        </div>\\n      </div>\\n\\n      <div class=\\\"col-xs-6\\\">\\n        <h2>Upcoming Invoice</h2>\\n        <div class=\\\"panel-group\\\" id=\\\"upcoming-invoice-accordion\\\">\\n          \",[\"#\",[[0,\"with\"],[0,\"upcomingInvoice\"]],[\"\\n            \",[\">\",\"_invoice\"],\"\\n          \"],[\"\\n            <i class=\\\"fa fa-spinner fa-3x fa-spin billing-loader\\\"></i>\\n          \"]],\"\\n          </div>\\n      </div>    \\n    \\n    </div>\\n    <div class=\\\"row billing-footer\\\">\\n      <div class=\\\"col-md-12\\\">\\n        <div class=\\\"pull-right\\\">\\n          \",[\"#\",[[0,\"if\"],[0,\"showPricingPlan\"]],[\"\\n          <div class=\\\"price\\\">\\n            \",[\"{\",[[0,\"pricingPlan\"]]],\"\\n          </div>\\n          \"]],\"\\n          <button id=\\\"cancel-subscription\\\" class=\\\"btn btn-danger pull-right\\\">\\n            <i class=\\\"fa fa-times\\\"></i>\\n            Cancel Subscription\\n            \",[\"#\",[[0,\"if\"],[0,\"cancelingSubscription\"]],[\"\\n              <i class=\\\"fa fa-spinner fa-spin\\\"></i>\\n            \"]],\"\\n          </button>\\n        </div>\\n      </div>\\n    </div>\\n  </div>\\n  \",[\">\",\"cancelSubscriptionModal\"]]));\nTemplate.__define__(\"cancelSubscriptionModal\",Package.handlebars.Handlebars.json_ast_to_func([\"<div class=\\\"modal fade\\\" id=\\\"confirm-cancel-subscription\\\" tabindex=\\\"-1\\\">\\n    <div class=\\\"modal-dialog\\\">\\n      <div class=\\\"modal-content\\\">\\n        <div class=\\\"modal-header\\\">\\n          <button type=\\\"button\\\" class=\\\"close\\\" data-dismiss=\\\"modal\\\" aria-hidden=\\\"true\\\">&times;</button>\\n          <h4 class=\\\"modal-title\\\" id=\\\"myModalLabel\\\">Confirm Cancelling Subscription</h4>\\n        </div>\\n        <div class=\\\"modal-body\\\">\\n          Are you sure you want to cancel your subscription?  Your data will be saved, so you can re-enable your account at any time.\\n        </div>\\n        <div class=\\\"modal-footer\\\">\\n          <button type=\\\"button\\\" class=\\\"btn btn-danger\\\" data-dismiss=\\\"modal\\\"><i class=\\\"fa fa-times\\\"></i> Cancel</button>\\n          <button type=\\\"button\\\" class=\\\"btn btn-blue btn-confirm-cancel-subscription\\\">\\n            <i class=\\\"fa fa-check\\\"></i> \\n            Yes, cancel my subscription\\n          </button>\\n        </div>\\n      </div>\\n    </div>\\n  </div>\"]));\nTemplate.__define__(\"_invoice\",Package.handlebars.Handlebars.json_ast_to_func([\"<div class=\\\"panel panel-default invoice\\\">\\n    <div class=\\\"panel-heading\\\">\\n      <h4 class=\\\"panel-title\\\">\\n        <a data-toggle=\\\"collapse\\\" href=\\\"#\",[\"{\",[[0,\"id\"]]],\"\\\">\\n          <span class=\\\"text-primary\\\">\\n            <strong>\\n              \",[\"{\",[[0,\"invoiceAmt\"],[0,\"amount_due\"]]],\" on \",[\"{\",[[0,\"invoiceDate\"],[0,\"\",\"date\"]]],\"\\n            </strong>\\n          </span>\\n          \",[\"#\",[[0,\"if\"],[0,\"showInvoicePeriod\"]],[\"\\n          <span class=\\\"text-muted pull-right\\\"><small>\",[\"{\",[[0,\"invoiceDate\"],[0,\"period_start\"]]],\" - \",[\"{\",[[0,\"invoiceDate\"],[0,\"period_end\"]]],\"<small></span>\\n          \"]],\"\\n        </a>\\n      </h4>\\n    </div>\\n    <div id=\\\"\",[\"{\",[[0,\"id\"]]],\"\\\" class=\\\"panel-collapse collapse\\\">\\n      <div class=\\\"panel-body\\\">\\n        <div class=\\\"clearfix\\\">\\n          <span class=\\\"pull-left\\\"><h5>Line Items</h5></span>\\n          \",[\"#\",[[0,\"if\"],[0,\"paid\"]],[\"\\n          <span class=\\\"label label-success pull-right\\\">Paid</span>\\n          \"]],\"\\n        </div>\\n        \",[\"#\",[[0,\"each\"],[0,\"lines\",\"data\"]],[\"\\n          <div class=\\\"row\\\">\\n            <div class=\\\"col-md-6\\\">\\n              \",[\"{\",[[0,\"lineItemDescription\"]]],\"\\n            </div>\\n            <div class=\\\"col-md-4\\\">\\n              <span class=\\\"line-item-period pull-right\\\">\",[\"{\",[[0,\"lineItemPeriod\"]]],\"</span>\\n            </div>\\n            <div class=\\\"col-md-2\\\">\\n              <span class=\\\"pull-right\\\">\",[\"{\",[[0,\"invoiceAmt\"],[0,\"amount\"]]],\"</span>\\n            </div>\\n          </div>\\n        \"]],\"\\n        \",[\"#\",[[0,\"unless\"],[0,\"paid\"]],[\"\\n        <div class=\\\"row billing-disclaimer\\\">\\n          <div class=\\\"col-md-12\\\">\\n            <em>\\n            * \",[\"{\",[[0,\"invoiceExplaination\"]]],\"\\n            </em>\\n          </div>\\n        </div>\\n        \"]],\"\\n      </div>\\n    </div>\\n  </div>\"]));\n","Template.billing.created = ->\n  Session.set 'billing.error', null\n  Session.set 'billing.success', null\n  Session.set 'billing.invoices.past', null\n  Session.set 'billing.invoices.upcoming', null\n\n  Meteor.call 'getInvoices', (error, response) ->\n    if error then Session.set 'billing.error', 'Error getting past invoices.'\n    else Session.set 'billing.invoices.past', response.data\n\n  Meteor.call 'getUpcomingInvoice', (error, response) ->\n    if error\n      Session.set 'billing.error', 'Error getting upcoming invoice.'\n    else\n      response.id = new Meteor.Collection.ObjectID().toHexString()\n      Session.set 'billing.invoices.upcoming', response\n\ninDollars = (amt) ->\n  if amt >= 0\n    \"$#{(amt / 100).toFixed(2)}\"\n  else\n    \"-$#{Math.abs(amt / 100).toFixed(2)}\"\n\nformatDate = (timestamp) ->\n  d = new Date(timestamp * 1000)\n  d.getMonth()+1 + '/' + d.getDate() + '/' + d.getFullYear()\n\n\nTemplate.billing.helpers\n  billingError: ->\n    Session.get 'billing.error'\n\n  billingSuccess: ->\n    Session.get 'billing.success'\n\n  cancelingSubscription: ->\n    Session.get 'billing.cancelingSubscription'\n\n  invoices: ->\n    Session.get 'billing.invoices.past'\n\n  upcomingInvoice: ->\n    Session.get 'billing.invoices.upcoming'\n\n  showPricingPlan: ->\n    Billing.settings.showPricingPlan\n\n  pricingPlan: ->\n    upcomingInvoice = Session.get 'billing.invoices.upcoming'\n    if upcomingInvoice\n      sub = _.findWhere upcomingInvoice.lines.data, type: 'subscription'\n      plan = sub.plan\n      \"#{inDollars(plan.amount)}/#{plan.interval}\"\n\n\nTemplate.billing.events\n  'click #cancel-subscription': (e) ->\n    e.preventDefault()\n    $('#confirm-cancel-subscription').modal('show')\n\n\n#\n#  Cancel Subscription Modal\n#\nTemplate.cancelSubscriptionModal.created = ->\n  Session.set 'billing.cancelingSubscription', false\n\nTemplate.cancelSubscriptionModal.events\n  'click .btn-confirm-cancel-subscription': (e) ->\n    e.preventDefault()\n    $('#confirm-cancel-subscription').modal('hide')\n    Session.set 'billing.cancelingSubscription', true\n    Meteor.call 'cancelSubscription', Meteor.user().profile.customerId, (error, response) ->\n      Session.set 'billing.cancelingSubscription', false\n      if error\n        billingError.set 'Error canceling subscription.'\n      else\n        Session.set 'billing.success', 'Your subscription has been canceled.'\n\n\nTemplate._invoice.helpers\n  lineItemDescription: ->\n    if @type is 'subscription'\n      \"Subscription to #{@plan.name} (#{inDollars(@plan.amount)}/#{@plan.interval})\"\n    else if @type is 'invoiceitem'\n      @description\n\n  lineItemPeriod: ->\n    if @period.start is @period.end then formatDate(@period.start)\n    else \"#{formatDate(@period.start)} - #{formatDate(@period.end)}\"\n\n  invoiceDate: (timestamp) ->\n    formatDate(timestamp)\n\n  invoiceAmt: (amt) ->\n    inDollars(amt)\n\n  showInvoicePeriod: ->\n    Billing.settings.showInvoicePeriod\n\n  invoiceExplaination: ->\n    Billing.settings.invoiceExplaination","@Billing =\n  settings: {}\n  config: (opts) ->\n    defaults = \n      publishableKey: ''\n      showInvoicePeriod: true\n      showPricingPlan: true\n      invoiceExplaination: ''\n    @settings = _.extend defaults, opts\n  createToken: (form, callback) ->\n    Stripe.setPublishableKey(@settings.publishableKey);\n    $form = $(form)\n    Stripe.card.createToken(\n      number: $form.find('[name=cc-num]').val()\n      exp_month: $form.find('[name=cc-exp-month]').val()\n      exp_year: $form.find('[name=cc-exp-year]').val()\n      cvc: $form.find('[name=cc-cvc]').val()\n    , callback) # callback(status, response)","$.validator.setDefaults\n  errorClass: 'error-msg'\n  errorPlacement: (error, element) ->\n    error.appendTo(element.parents('.form-group'))\n  highlight: (element, errorClass) ->\n    $(element).parents('.form-group').addClass('has-error')\n  unhighlight: (element, errorClass) ->\n    $(element).parents('.form-group').removeClass('has-error')\n\n$.validator.addMethod \"exactlength\", (value, element, param) ->\n  @optional(element) || value.length is param\n, $.validator.format \"Must be {0} digits.\"\n\n@ccValidation = \n  'cc-num':\n    required: true\n    creditcard: true\n  'cc-exp-month':\n    required: true\n    digits: true\n    exactlength: 2\n    range: [1, 12]\n  'cc-exp-year':\n    required: true\n    digits: true\n    exactlength: 4\n  'cc-cvc':\n    required: true\n    digits: true\n    rangelength: [3, 4]"]}